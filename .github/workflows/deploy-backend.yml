name: Deploy Backend to EB (via ECR)

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

permissions:
  id-token: write   # para OIDC
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPO: ${{ secrets.ECR_REPO }}
  EB_APP_NAME: ${{ secrets.EB_APP_NAME }}
  EB_ENV_NAME: ${{ secrets.EB_ENV_NAME }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}

jobs:
  build-push-ecr:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/<ROLE_GITHUB_OIDC>

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:latest
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ github.sha }}

      - name: Compute image URI
        id: img
        run: |
          echo "URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Generate Dockerrun.aws.json (v2)
        run: |
          cat > Dockerrun.aws.json <<'JSON'
          {
            "AWSEBDockerrunVersion": 2,
            "containerDefinitions": [
              {
                "name": "web",
                "image": "${IMAGE_URI}",
                "essential": true,
                "memory": 512,
                "portMappings": [{ "hostPort": 8000, "containerPort": 8000 }],
                "environment": [
                  { "name": "DJANGO_SETTINGS_MODULE", "value": "core.settings" }
                ]
              }
            ]
          }
          JSON
          # reemplazar variable
          sed -i "s|\${IMAGE_URI}|${{ steps.img.outputs.URI }}|g" Dockerrun.aws.json
        working-directory: .

      - name: Upload application version bundle to S3
        run: |
          zip -9r app-${{ github.sha }}.zip Dockerrun.aws.json
          aws s3 cp app-${{ github.sha }}.zip s3://${S3_BUCKET}/app-${{ github.sha }}.zip

      - name: Create EB application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name "${EB_APP_NAME}" \
            --version-label "${GITHUB_SHA}" \
            --source-bundle S3Bucket="${S3_BUCKET}",S3Key="app-${GITHUB_SHA}.zip"

      - name: Update EB environment
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name "${EB_ENV_NAME}" \
            --version-label "${GITHUB_SHA}"
